# Historia #825041: Habilitar creaci√≥n de beneficiarios "Dummy" por carga masiva en Vida Grupo

**Estado:** En Desarrollo (Developer)

---

## Historia de Usuario

**Como** expedidor de p√≥lizas de Vida Grupo,  
**Quiero** crear beneficiarios tipo "Dummy" (Persona) mediante carga masiva dejando los campos de identificaci√≥n vac√≠os,  
**Para** agilizar la emisi√≥n de p√≥lizas sin detenerme por documentos faltantes, permitiendo adem√°s reemplazar cualquier lista de beneficiarios previa por la nueva informaci√≥n cargada.

## Descripci√≥n

Permitir la creaci√≥n de beneficiarios sin n√∫mero de identificaci√≥n (Dummy) de forma masiva para evitar bloqueos en la suscripci√≥n dentro del proceso de carga masiva de riesgos y beneficiarios en p√≥lizas de Vida Grupo. El sistema determinar√° autom√°ticamente si debe crear un beneficiario "Dummy" o un "Contacto Completo" bas√°ndose en si los campos de identificaci√≥n (Tipo y N√∫mero de Documento) vienen vac√≠os o diligenciados en el archivo de carga. Adicionalmente, esta carga funciona como una **actualizaci√≥n completa** de la designaci√≥n de beneficiarios, asegurando que la informaci√≥n en el sistema refleje exactamente lo √∫ltimo cargado por el usuario (sobrescritura total, no fusi√≥n).

---

## Criterios de Aceptaci√≥n

### Escenario 1: Crear Beneficiario Dummy (Campos Vac√≠os)

- **Dado** que el expedidor est√° diligenciando la plantilla de carga masiva para un riesgo
- **Cuando** ingrese el Nombre del beneficiario pero deje **VAC√çOS** tanto el campo "Tipo de Documento" como el "N√∫mero de Documento"
- **Entonces** el sistema debe crear el beneficiario exitosamente como un contacto tipo **Persona** con identificaci√≥n Dummy interna y relacionarlo con el asegurado en cuesti√≥n

### Escenario 2: Validaci√≥n de Integridad (Campos Parciales)

- **Dado** que se procesa el archivo de carga masiva en Azure Data Factory (Fase 1)
- **Cuando** el sistema detecta un registro donde existe un "N√∫mero de Documento" pero el "Tipo de Documento" est√° vac√≠o (o viceversa)
- **Entonces** debe rechazar ese registro espec√≠fico y generar una entrada en el archivo de errores de Fase 1 indicando la inconsistencia

### Escenario 3: Crear Contacto Completo (Campos Diligenciados)

- **Dado** que el expedidor est√° diligenciando la plantilla de carga masiva para un riesgo
- **Cuando** ingrese el Nombre del beneficiario y adem√°s diligencia tanto el campo "Tipo de Documento" (CC, CE, etc.) como el "N√∫mero de Documento" con datos v√°lidos
- **Entonces** el sistema debe crear el beneficiario como un contacto completo (comportamiento est√°ndar actual) y relacionarlo con el asegurado

### Escenario 4: Reemplazo Total de Beneficiarios Existentes

- **Dado** que existe un riesgo (asegurado) en el sistema que ya tiene beneficiarios asignados (ejemplo: Beneficiario A y B)
- **Cuando** se procesa exitosamente una carga masiva para ese mismo riesgo con una nueva lista de beneficiarios (ejemplo: Beneficiario C)
- **Entonces** el sistema debe eliminar la asignaci√≥n de los beneficiarios antiguos (A y B) y dejar √∫nicamente al nuevo beneficiario (C) asociado al riesgo

### Escenario 5: Carga para Asegurado sin Beneficiarios Previos

- **Dado** que existe un riesgo (asegurado) en el sistema que NO tiene beneficiarios asignados previamente
- **Cuando** se procesa exitosamente una carga masiva con una lista de beneficiarios para ese riesgo
- **Entonces** el sistema debe crear y asociar los nuevos beneficiarios al asegurado (resultado equivalente al reemplazo, pero sin eliminar registros previos porque no existen)

### Escenario 6: Visualizaci√≥n en la Interfaz

- **Dado** que se cre√≥ un beneficiario Dummy mediante la l√≥gica de campos vac√≠os y se proces√≥ exitosamente en Fase 2
- **Cuando** se consulte el riesgo en las pantallas de consulta de PolicyCenter
- **Entonces** se debe visualizar el beneficiario creado, mostrando el tipo de documento "Dummy Persona" (o la etiqueta equivalente en UI) asignado autom√°ticamente por el sistema

---

## Informaci√≥n Recopilada

### Usuario y Contexto

- **Tipo de usuario:** Expedidor de p√≥lizas de Vida Grupo con permisos para realizar cargas masivas
- **Permisos requeridos:** Acceso a p√≥liza master, permisos para ejecutar "Procesos Masivos" (acci√≥n est√°ndar de expedidores)
- **Valor de negocio:** Agilizar el proceso de emisi√≥n de p√≥lizas colectivas sin bloqueos por documentos faltantes de beneficiarios, mejorando tiempos de expedici√≥n y evitando reprocesos por informaci√≥n incompleta

### Reglas de Negocio

**Tabla de Decisi√≥n - Creaci√≥n de Beneficiarios:**

| Campo: Tipo Documento | Campo: N√∫mero Documento | Acci√≥n del Sistema |
|----------------------|-------------------------|-------------------|
| VAC√çO | VAC√çO | Crear Beneficiario Dummy (Persona) - El sistema asume internamente el tipo dummy de persona |
| Seleccionado (CC, CE, etc.) | Con Datos | Crear Contacto Completo (Comportamiento est√°ndar actual) |
| Seleccionado (CC, CE, etc.) | VAC√çO | Error: "El n√∫mero de documento es obligatorio si se selecciona un tipo" |
| VAC√çO | Con Datos | Error: "El tipo de documento es obligatorio si se ingresa un n√∫mero" |

**L√≥gica de Reemplazo de Beneficiarios (Sobrescritura):**
- Si el riesgo (asegurado) al que se le est√° cargando informaci√≥n **YA tiene beneficiarios asociados** en el sistema, la carga masiva **eliminar√°/desvincular√°** los beneficiarios existentes y registrar√° **exclusivamente** los nuevos beneficiarios incluidos en el archivo
- **Nota importante:** No es una fusi√≥n (merge), es un reemplazo total de la lista para ese riesgo

**Productos Afectados:**
- Vida Integral
- Vida Docentes
- Vida Deudores
- Vida Condiciones Uso

**Pre-requisitos:**
- Los riesgos (asegurados) deben existir en la P√≥liza Maestra
- Transacci√≥n: Movimientos de modificaci√≥n

**Especificaciones T√©cnicas:**
- **Plantilla:** No se agregan nuevos tipos de documento a la lista desplegable. Se utiliza la plantilla est√°ndar existente
- **Tipo de Contacto:** Los beneficiarios creados por la l√≥gica "Vac√≠o/Vac√≠o" siempre ser√°n de tipo **Persona**, nunca Compa√±√≠a
- **Validaciones Azure (Fase 1):** Ajustar para permitir valores nulos en las columnas de Tipo y N√∫mero de documento (actualmente son obligatorios, deben pasar a opcionales)

### Interfaz

**Navegaci√≥n:**
1. Usuario accede a la pantalla de **detalle de p√≥liza master** mediante el n√∫mero de p√≥liza
2. En la secci√≥n **"Acciones"**, hace click para desplegar opciones
3. Selecciona la opci√≥n **"Procesos Masivos"** (se despliegan m√°s opciones)
4. Hace click en **"Carga Masiva asegurados"** (nombre puede causar confusi√≥n, pero aplica tanto para riesgos como beneficiarios)
5. Se redirige a **LifeCreateMassivelyInsuredsPopup.pcf** (p√°gina del hist√≥rico de todas las cargas masivas de riesgos y beneficiarios)
6. En el hist√≥rico, hay un bot√≥n para **"Descargar plantillas de carga"** y otro para **"Hacer la carga"**
7. Al hacer click en "Hacer la carga", redirige a **MassiveLoadPopup.pcf** (pantalla de carga de archivo)

**Pantallas Involucradas:**
- **LifeCreateMassivelyInsuredsPopup.pcf**: Dashboard del hist√≥rico de cargas masivas (riesgos y beneficiarios)
- **MassiveLoadPopup.pcf**: Popup de carga de archivo masivo

**Plantilla de Carga:**
- La plantilla actual **ya contiene** las columnas "Tipo de Documento" y "N√∫mero de Documento"
- **No se requieren modificaciones** a la plantilla existente
- La plantilla soporta carga de beneficiarios con las columnas est√°ndar (Nombre, Tipo Documento, N√∫mero Documento, Porcentaje, Parentesco, etc.)

**Proceso de Carga:**
- La carga se procesa de forma **as√≠ncrona en segundo plano** (no sincr√≥nica)
- **No se requiere confirmaci√≥n o advertencia** al usuario antes de sobrescribir beneficiarios existentes, ya que el proceso es no bloqueante y el usuario puede continuar trabajando

**Visualizaci√≥n Post-Carga:**
- Una vez creado el beneficiario Dummy exitosamente, **ya se podr√° visualizar** en las pantallas de consulta de PolicyCenter
- El sistema muestra autom√°ticamente el tipo "Dummy Persona" (o etiqueta equivalente)
- **No se requiere implementaci√≥n adicional** para visualizaci√≥n (Criterio 6 ya est√° cubierto por funcionalidad existente)
- Lo √∫nico que se debe garantizar es que el beneficiario se **cree y relacione correctamente** con el asegurado en cuesti√≥n

### Sistemas Externos

**Azure Data Factory (Fase 1 - Validaci√≥n de Estructura):**
- Responsable de la validaci√≥n de formato y estructura del archivo mediante expresiones regulares
- **Ajuste requerido:** Modificar validaciones para **permitir campos vac√≠os** en las columnas "TipoDocumento" y "NumeroDocumento" (actualmente estas columnas son obligatorias en Fase 1)
- **Nota:** No es permitir valores NULL en base de datos, sino permitir celdas vac√≠as en el archivo CSV/Excel durante la validaci√≥n de Azure

**PolicyCenter Workqueues (Fase 2 - Validaci√≥n de Negocio):**
- **Workqueue Enrichment**: Valida reglas de negocio y transforma datos seg√∫n l√≥gica de decisi√≥n
- **Workqueue BulkInsert**: Inserta/actualiza los beneficiarios en base de datos seg√∫n operaci√≥n (Ingreso/Modificaci√≥n/Cancelaci√≥n/Renovaci√≥n)

**RabbitMQ:**
- Mensajer√≠a as√≠ncrona entre Azure Data Factory y PolicyCenter para notificaciones de estado de carga

**Cosmos DB:**
- Almacenamiento de registros de carga, errores de validaci√≥n por fase y metadatos del proceso

**Azure Storage Account:**
- Almacenamiento de archivos originales y archivos de errores generados (ErrorFase1_{md5}.csv, ErrorFase2_{md5}.csv)

---

## Contexto y Referencias

**Arquitectura:**
- [Flujo Carga Masiva de Riesgos y Beneficiarios](../architecture/flujo-carga-masiva-riesgos-beneficiarios.md) - Documentaci√≥n end-to-end del proceso de 2 fases (Azure + PolicyCenter)
- [Architecture PolicyCenter](../architecture/architecture-policycenter.md) - Arquitectura del componente principal (Gosu/Java, Guidewire 8.0.7)

**Historias relacionadas:**
- #915240: Bug - Organizar campos errados detalle de cobro
- #830317: Ajustar comportamiento descarga detalle cobro

**Lecciones aprendidas:**

**Del Flujo de Carga Masiva:**
- **Procesamiento as√≠ncrono en 2 fases:** Fase 1 (Azure - validaci√≥n estructura/formato) + Fase 2 (PolicyCenter - validaci√≥n negocio/inserci√≥n). Ambas fases deben estar alineadas en sus validaciones.
- **Workqueues programadas por volumen:** El sistema clasifica cargas en Low/Medium/High y ejecuta workqueues en horarios espec√≠ficos. Considerar impacto en tiempos de procesamiento.
- **Archivos de errores por fase:** Usuarios descargan errores espec√≠ficos de cada fase (ErrorFase1 vs ErrorFase2) para correcci√≥n y recarga.
- **Validaci√≥n de carga en progreso:** Antes de permitir nueva carga, verificar que no haya otra carga activa para la misma p√≥liza (evitar conflictos).

**De Historias Relacionadas:**
- **Claridad en mensajes de error:** Los archivos de errores deben especificar claramente qu√© campo fall√≥ y por qu√© (cr√≠tico para correcci√≥n por parte del expedidor).
- **Validaci√≥n de permisos:** Verificar que el expedidor tenga permisos adecuados antes de iniciar el proceso de carga.
- **Casos sin resultados:** Si la carga no tiene registros v√°lidos despu√©s de Fase 1, mostrar mensaje claro al usuario en el dashboard.

---

## Definici√≥n de Terminado (Inicial)

- [ ] Funcionalidad de creaci√≥n de beneficiarios Dummy implementada seg√∫n criterios de aceptaci√≥n
- [ ] Validaciones de Azure Data Factory ajustadas para permitir campos vac√≠os en TipoDocumento y NumeroDocumento
- [ ] L√≥gica de decisi√≥n autom√°tica (tabla de 4 escenarios) implementada en Workqueue Enrichment
- [ ] L√≥gica de reemplazo total de beneficiarios implementada en Workqueue BulkInsert
- [ ] Beneficiarios Dummy creados como tipo "Persona" y relacionados correctamente con asegurados
- [ ] Mensajes de error claros implementados en archivos ErrorFase1 y ErrorFase2 para casos de inconsistencia
- [ ] Pruebas de carga masiva con diferentes combinaciones de campos (vac√≠os, completos, parciales) exitosas
- [ ] Validaci√≥n de que beneficiarios existentes se reemplazan correctamente (no se fusionan)
- [ ] Visualizaci√≥n correcta de beneficiarios Dummy en pantallas de consulta de PolicyCenter

---

## Registro de Cambios

| Fecha | Versi√≥n | Descripci√≥n | Autor |
|-------|---------|-------------|-------|
| 2025-12-18 | 1.0 | Historia creada e importada por PO con mejoras de claridad y completitud | esteban.colorado (PO) |
| 2025-12-22 | 1.1 | An√°lisis arquitect√≥nico completado con decisi√≥n de refactorizaci√≥n integral del flujo | esteban.colorado (Arquitecto) |
| 2025-12-23 | 1.2 | Refinamiento t√©cnico completado con descomposici√≥n en tareas y estrategia de testing | esteban.colorado (Developer) |

---

## Refinamiento T√©cnico (Developer)

### Consideraciones Generales

**Basado en an√°lisis arquitect√≥nico:**
El arquitecto identific√≥ 9 hitos de implementaci√≥n con patr√≥n Strategy + Factory para creaci√≥n de contactos. La implementaci√≥n reutiliza `ContactUtil.createNewContactDummy()` existente y extiende `CommonTransformer` para soportar PersonDummy_Ext y CompanyDummy_Ext. El flujo de carga masiva (2 fases: Azure + PolicyCenter) permanece intacto, solo se agrega l√≥gica de decisi√≥n en Fase 2.

**Nivel de complejidad:**
**MEDIO-ALTO** - Refactorizaci√≥n con Strategy Pattern requiere dise√±o cuidadoso, pero reutiliza componentes existentes. La modificaci√≥n de `regex.csv` es cr√≠tica y requiere validaci√≥n exhaustiva. Limpieza de c√≥digo deprecado reduce riesgo de regresi√≥n.

**Riesgos t√©cnicos conocidos:**
- **CR√çTICO**: Modificaci√≥n de `regex.csv` (4000+ caracteres en 1 l√≠nea) puede romper validaciones existentes de riesgos si no se prueba exhaustivamente
- **ALTO**: Tests de regresi√≥n despu√©s de eliminar `TC_ADDITIONALINTEREST` deben cubrir TODOS los tipos de carga masiva
- **MEDIO**: Determinaci√≥n autom√°tica Persona vs Compa√±√≠a basada en apellidos puede causar errores si usuario ingresa nombre de compa√±√≠a con apellido
- **BAJO**: Strategy Pattern agrega indirecci√≥n que puede dificultar debugging inicial

**Patrones y convenciones del equipo:**
- **Gosu**: C√≥digo en ingl√©s, comentarios en espa√±ol, sin strings literales (usar constantes), indentaci√≥n 2 espacios, sin punto y coma
- **Nomenclatura**: PascalCase para clases, camelCase para m√©todos/variables, UPPER_SNAKE_CASE para constantes
- **Enhancement**: Todas las extensiones nuevas fuera del paquete `sura` deben terminar en `_Ext`
- **Tests**: Directorio `gtest/`, extender de `EESuraTestBase`, usar `@RunLevel(NONE)`, patr√≥n AAA obligatorio, `Mockito.spy()` para clase bajo prueba
- **Validaciones**: Comparar sobre constantes (evitar NPE), validar nulos antes de acceder propiedades
- **Archivos**: Sin l√≠neas vac√≠as al inicio/final, sin c√≥digo comentado

**Dependencias nuevas a instalar:**
Ninguna - Se reutilizan todas las dependencias existentes del proyecto (Mockito, Guidewire TestBase, ContactUtil, CommonTransformer, IContactPlugin).

**Estrategia de testing:**
**Framework**: GUnit (JUnit modificado de Guidewire) con Mockito para mocking | **Tipos**: Tests unitarios exclusivamente (Guidewire no permite tests de integraci√≥n/E2E) | **Cobertura**: >70% (umbral m√≠nimo Guidewire) | **Test Data Builders**: Reutilizar builders existentes en `EESuraTestBase` (`createGetPolicyLinePropertyAccessor`, `createGroupLifeLine`)

### Historias Relacionadas Consultadas

**Implementaciones similares analizadas:**
- Historia #915240 (Bug - Organizar campos errados detalle de cobro): Patr√≥n de validaci√≥n de integridad de datos en reportes masivos, manejo de archivos de errores
- Historia #830317 (Ajustar comportamiento descarga detalle cobro): Manejo de archivos de errores y notificaciones a usuario en procesos masivos
- `DefaultBeneficiaryTransformerEESuraTestBase.gs`: Tests unitarios existentes de transformadores con mocking de `IContactPlugin` y `CommonTransformer`
- `AddlInterestDetailEnhancementTest.gs`: Tests unitarios de enhancements con `mockStatic` y `verifyStaticPropertyGet`

**Patrones de c√≥digo reutilizados:**
- **Strategy Pattern**: Usado en transformadores masivos (`TransformerFactoryProducer`, `OperationValidationFactory`)
- **Factory Pattern**: Usado para selecci√≥n de transformadores por tipo de archivo
- **DTO Pattern**: Usado en `CommonTransformer` para mapeo entre entidades y DTOs
- **mockStatic obligatorio**: Para enhancements y clases con m√©todos est√°ticos (`ContactUtil.createNewContactDummy()`)
- **Spy Pattern**: `Mockito.spy()` obligatorio para clase bajo prueba (evita problemas de ClassLoader)

**Mejores pr√°cticas aplicadas:**
- Reutilizaci√≥n de `ContactUtil.createNewContactDummy()` en lugar de duplicar l√≥gica
- Encapsulaci√≥n de responsabilidades (Factory decide, Strategy ejecuta)
- Tests unitarios con patr√≥n AAA, mocking apropiado de dependencias externas
- Validaci√≥n de integridad en Fase 2 (PolicyCenter) en lugar de Fase 1 (Azure) - Separaci√≥n de responsabilidades
- Limpieza de c√≥digo deprecado antes de agregar nueva funcionalidad - Reduce deuda t√©cnica

---

## Tareas de Implementaci√≥n (Developer)

### Fase 0: Infraestructura y Migraciones ‚úÖ COMPLETADA

#### Cambios de Configuraci√≥n

- [x] **Modificar validaciones de Azure Data Factory**
  - [x] Modificar archivo `VidaGrupoIAC/modules/datafactory/controlSchema/Beneficiaries/regex.csv`
  - [x] Hacer opcional `TIPO_DOCUMENTO_BENEFICIARIO_X` agregando `|(^$)` al final de cada regex
  - [x] Hacer opcional `NUM_DOCUMENTO_BENEFICIARIO_X` agregando `?` al cuantificador

---

### Fase 1: Limpieza de C√≥digo Deprecado ‚úÖ COMPLETADA

#### üì¶ PolicyCenter - Limpieza Transformadores

- [x] **Eliminar referencia deprecada TC_ADDITIONALINTEREST** (AC: N/A - Limpieza t√©cnica)
  - [x] Eliminar caso `TC_ADDITIONALINTEREST` en `TransformerFactoryProducer.gs`

- [x] **Eliminar validaci√≥n duplicada en OperationValidationFactory** (AC: N/A - Limpieza t√©cnica)
  - [x] Eliminar condici√≥n especial para `TC_ADDITIONALINTEREST` en `OperationValidationFactory.gs`

- [x] **Simplificar m√©todo getOperationValidation en EnrichmentProcessing** (AC: N/A - Limpieza t√©cnica)
  - [x] Reemplazar llamada por `getOperationValidationFactory().createOperationValidatorInstance()`

---

### Fase 2: Implementaci√≥n de Strategy Pattern ‚úÖ COMPLETADA

#### üì¶ PolicyCenter - Interfaces y Contratos

- [x] **Crear interface ContactCreationStrategy**
  - [x] Archivo: `sura/pc/massiveupload/strategy/ContactCreationStrategy.gs`

#### üì¶ PolicyCenter - Implementaci√≥n de Estrategias

- [x] **Implementar DummyContactCreationStrategy** (AC: 1, 6)
  - [x] Archivo: `sura/pc/massiveupload/strategy/DummyContactCreationStrategy.gs`
  - [x] Tests: `DummyContactCreationStrategyTest.gs` (5 tests)

- [x] **Implementar CompleteContactCreationStrategy** (AC: 3)
  - [x] Archivo: `sura/pc/massiveupload/strategy/CompleteContactCreationStrategy.gs`
  - [x] Tests: `CompleteContactCreationStrategyTest.gs` (5 tests)

#### üì¶ PolicyCenter - Factory de Estrategias

- [x] **Implementar ContactCreationStrategyFactory** (AC: 1, 2, 3)
  - [x] Archivo: `sura/pc/massiveupload/strategy/ContactCreationStrategyFactory.gs`
  - [x] Tests: `ContactCreationStrategyFactoryTest.gs` (9 tests)

---

### Fase 3: Refactorizaci√≥n de Transformadores ‚úÖ COMPLETADA

#### üì¶ PolicyCenter - Validaciones de Beneficiarios

- [x] **Modificar DefaultBeneficiaryValidation para soportar Dummy** (AC: 1, 2)
  - [x] Remover `TIPO_DOCUMENTO_BENEFICIARIO_1` y `NUM_DOCUMENTO_BENEFICIARIO_1` de campos obligatorios
  - [x] Permitir ambos campos vac√≠os (Dummy) o ambos llenos (Completo)
  - [x] Agregar display key: `Sura.MassiveUpload.Validations.beneficiaryDocumentIncomplete` (es_CO, en_US, en_US_edg)
  - [x] Tests: `DefaultBeneficiaryValidationEESuraTestBase.gs` (3 tests nuevos)

#### üì¶ PolicyCenter - Refactorizaci√≥n Transformador de Beneficiarios

- [x] **Refactorizar DefaultBeneficiaryTransformer.createInterestContingent()** (AC: 1, 2, 3)
  - [x] Integrar `ContactCreationStrategyFactory.getStrategy()`

---

### Fase 4: Extensi√≥n de CommonTransformer ‚úÖ COMPLETADA

#### üì¶ PolicyCenter - Soporte para Contactos Dummy

- [x] **Extender CommonTransformer.contactToAdditionalInterest()** (AC: 1, 6)
  - [x] Agregar soporte para `PersonDummy_Ext`
  - [x] Crear m√©todo `setPersonDummyAdditionalInterestData()`
  - [x] Tests: `CommonTransformerTest.gs` (2 tests corregidos)

**Nota**: Solo se implement√≥ soporte para `PersonDummy_Ext` ya que por regla de negocio los beneficiarios Dummy siempre son personas.

---

### Fase 5: Code Quality ‚è≥ PENDIENTE

#### üì¶ Revisi√≥n de C√≥digo

- [ ] **Ejecutar Agente Peer Review**
  - Revisar cumplimiento de est√°ndares de c√≥digo Sura
  - Validar nomenclatura, formato, strings en constantes
  - Verificar tests unitarios

- [ ] **Resolver incidentes del Peer Review** (Condicional)
  - Aplicar correcciones sugeridas por peer reviewer
  - Re-ejecutar tests unitarios

---

### Entregables al Equipo de Negocio (Post-Deployment)

> **Nota**: Las siguientes actividades ser√°n realizadas por el equipo de negocio en ambiente de laboratorio despu√©s del deployment.

#### Pruebas Funcionales a Realizar por Negocio

| Escenario | Datos de Entrada | Resultado Esperado |
|-----------|------------------|-------------------|
| Beneficiario Dummy | TIPO_DOC y NUM_DOC vac√≠os, con nombres completos | Crear `PersonDummy_Ext` con direcci√≥n dummy |
| Beneficiario Completo | TIPO_DOC y NUM_DOC con valores v√°lidos | Buscar contacto existente o usar datos del CSV |
| Error: Solo Tipo | TIPO_DOC con valor, NUM_DOC vac√≠o | Error en Fase 2: "documento incompleto" |
| Error: Solo N√∫mero | TIPO_DOC vac√≠o, NUM_DOC con valor | Error en Fase 2: "documento incompleto" |
| Regresi√≥n: Riesgos | Carga de riesgos est√°ndar | Funciona igual que antes |

#### Criterios de Aceptaci√≥n a Validar

- **AC1**: Beneficiarios sin documento se crean como Dummy autom√°ticamente
- **AC2**: Error claro cuando solo viene tipo O solo viene n√∫mero
- **AC3**: Beneficiarios con documento completo funcionan igual (regresi√≥n)
- **AC4**: Beneficiarios existentes se reemplazan (no se fusionan)
- **AC5**: Suma de porcentajes sigue validando 100%
- **AC6**: Beneficiarios Dummy se visualizan correctamente en UI

---

**Resumen de Vinculaci√≥n con Criterios de Aceptaci√≥n:**
- Fase 0: Habilita el flujo (campos opcionales en Azure)
- Fase 1: Limpieza t√©cnica (reduce deuda t√©cnica)
- Fase 2-4: Implementan AC 1, 2, 3, 6 (creaci√≥n autom√°tica seg√∫n tabla de decisi√≥n)
- Fase 5: Asegura calidad de c√≥digo antes de PR

---

## An√°lisis Arquitect√≥nico (Arquitecto)

<!-- ============================================================================ -->
<!-- SECCI√ìN AGREGADA POR: Workflow analizar-disenar-historia-usuario            -->
<!-- ETAPA: An√°lisis Arquitect√≥nico                                              -->
<!-- RESPONSABLE: Arquitecto                                                     -->
<!-- ============================================================================ -->

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** Strategy Pattern + Factory Pattern con Extensi√≥n de Decisi√≥n por Entidad

**Justificaci√≥n:** 

El flujo de carga masiva de beneficiarios ya existe y est√° consolidado (arquitectura de 2 fases: Azure + PolicyCenter). La historia NO requiere un nuevo flujo sino **ampliar la l√≥gica de decisi√≥n existente** para soportar un caso adicional: beneficiarios sin identificaci√≥n (Dummy).

Este patr√≥n permite:

1. **Reutilizar infraestructura existente**: Mismo flujo PCF ‚Üí JavaScript ‚Üí Azure Fase 1 ‚Üí PolicyCenter Fase 2
2. **Escalabilidad**: Separar responsabilidades de creaci√≥n de contactos (Strategy) vs. transformaci√≥n de datos
3. **Mantenibilidad**: Eliminar c√≥digo duplicado y deprecado (TC_ADDITIONALINTEREST), centralizando l√≥gica en estrategias reutilizables
4. **Reutilizaci√≥n**: Aprovechar `ContactUtil.createNewContactDummy()` existente del flujo uno-a-uno en lugar de duplicar l√≥gica
5. **Extensibilidad**: Facilitar agregar nuevos tipos de contactos o validaciones sin modificar core del transformador

La decisi√≥n de usar Strategy Pattern se toma en lugar de simples condicionales inline porque:
- Permite pruebas unitarias independientes de cada estrategia
- Facilita extensi√≥n futura (ej: estrategia de integraci√≥n con sistema externo de validaci√≥n de identidad)
- Separa l√≥gica de decisi√≥n (Factory) de l√≥gica de creaci√≥n (Strategies)
- Mejora legibilidad al eliminar anidamiento excesivo de if-else en DefaultBeneficiaryTransformer

**Componentes Afectados:**

**NUEVOS COMPONENTES:**

- **ContactCreationStrategy.gs (Interface - NUEVO):** Define contrato para estrategias de creaci√≥n de contactos. Contrato: `createContact(requestDTO, number, commonTransformer): Contact` y `supportsType(documentType, documentNumber): boolean`
  
- **DummyContactCreationStrategy.gs (Implementaci√≥n - NUEVO):** Estrategia para crear PersonDummy_Ext o CompanyDummy_Ext. Reutiliza `ContactUtil.createNewContactDummy()` del flujo uno-a-uno. Determina tipo (Persona vs Compa√±√≠a) bas√°ndose en presencia de apellidos. Pobla datos desde CSV y asigna direcci√≥n dummy est√°ndar.
  
- **CompleteContactCreationStrategy.gs (Implementaci√≥n - NUEVO):** Estrategia para buscar/crear contactos completos. Encapsula comportamiento actual usando `IContactPlugin.searchContact()` y `CommonTransformer.contactToAdditionalInterest()`.
  
- **ContactCreationStrategyFactory.gs (Factory - NUEVO):** Decide qu√© estrategia usar bas√°ndose en tabla de decisi√≥n de 4 escenarios (vac√≠o/vac√≠o ‚Üí Dummy, lleno/lleno ‚Üí Complete, mixto ‚Üí ValidationException). Centraliza validaci√≥n de consistencia.

**COMPONENTES MODIFICADOS:**

- **DefaultBeneficiaryTransformer.gs (REFACTORIZACI√ìN MAYOR):** Simplificar m√©todo `createInterestContingent()` eliminando l√≥gica inline de creaci√≥n de contactos. Delegar a `ContactCreationStrategyFactory.getStrategy()`. Reducci√≥n estimada de ~30 l√≠neas de c√≥digo a ~5 l√≠neas usando factory.
  - Nivel de cambio: Mayor
  - Especificaciones: Modificar l√≠neas 85-95. Reemplazar b√∫squeda directa de contacto con: `var strategy = ContactCreationStrategyFactory.getStrategy(documentType, documentNumber, _iContactPlugin); var contact = strategy.createContact(requestDTO, number, _commonTransformer);`
  
- **CommonTransformer.contactToAdditionalInterest() (EXTENSI√ìN MODERADA):** Agregar soporte para PersonDummy_Ext y CompanyDummy_Ext. Actualmente solo maneja Person y Company est√°ndar (l√≠neas 350-375). Agregar type checking al inicio del m√©todo para detectar contactos Dummy y delegar a m√©todos espec√≠ficos `setPersonDummyAdditionalInterestData()` y `setCompanyDummyAdditionalInterestData()`.
  - Nivel de cambio: Menor
  - Especificaciones: Agregar condiciones `if (contact typeis PersonDummy_Ext)` y `if (contact typeis CompanyDummy_Ext)` antes de l√≥gica existente. Crear 2 m√©todos nuevos protected para mapeo de Dummy a DTO.
  
- **Azure DataFactory - regex.csv (MODIFICACI√ìN CR√çTICA):** Relajar validaciones para permitir campos vac√≠os en TIPO_DOCUMENTO_BENEFICIARIO_X (hacer opcional agregando `|(^$)`) y NUM_DOCUMENTO_BENEFICIARIO_X (agregar `?` al cuantificador). Sin este cambio, registros con campos vac√≠os son rechazados en Fase 1 y nunca llegan a PolicyCenter.
  - Nivel de cambio: Cr√≠tico - Habilita todo el flujo
  - Especificaciones: Archivo `VidaGrupoIAC/modules/datafactory/controlSchema/Beneficiaries/regex.csv`, segunda l√≠nea (regex consolidado), modificar patrones de beneficiarios 1-5.

**LIMPIEZA DE C√ìDIGO DEPRECADO:**

- **TransformerFactoryProducer.gs (LIMPIEZA):** Eliminar l√≠nea 9: `case typekey.MassiveLoadFileType.TC_ADDITIONALINTEREST.Code : return new BeneficiaryTransformerFactory()`. TC_ADDITIONALINTEREST es versi√≥n deprecada que no se usa.
  - Nivel de cambio: Menor
  
- **OperationValidationFactory.gs (LIMPIEZA):** Eliminar l√≠neas 20-22: condici√≥n especial `if(message.FileType == typekey.MassiveLoadFileType.TC_ADDITIONALINTEREST)`. Simplificar switch eliminando caso duplicado.
  - Nivel de cambio: Menor
  
- **EnrichmentProcessing.gs (SIMPLIFICACI√ìN):** Eliminar m√©todo `getOperationValidation()` completo y reemplazar por llamada directa a `getOperationValidationFactory().createOperationValidatorInstance()` (l√≠neas 166-172). L√≥gica especial para TC_BENEFICIARIES ya no es necesaria.
  - Nivel de cambio: Menor

**COMPONENTES SIN CAMBIOS (VALIDADO):**

- ContactUtil.gs - Ya tiene m√©todos `createNewContactDummy()`, `mapAccountContact()`, `updateAddressDummy()` completamente funcionales
- PersonDummy_Ext.eti / CompanyDummy_Ext.eti - Entidades ya existen y est√°n configuradas
- EdgeProcessing.gs - Reemplazo total de beneficiarios ya funciona correctamente (no distingue entre Dummy y Complete)
- PCF UI (LifeCreateMassivelyInsuredsPopup.pcf, MassiveLoadPopup.pcf, DashBoardMassiveUploadLV.pcf) - No requieren modificaci√≥n

**Hitos de Implementaci√≥n:**

1. **Azure DataFactory regex.csv** - Modificar validaciones de formato para hacer opcionales TIPO_DOCUMENTO_BENEFICIARIO_X y NUM_DOCUMENTO_BENEFICIARIO_X. Sin esto, registros nunca llegan a Fase 2.
   - Dependencias: Ninguna - Cambio aislado en infraestructura

2. **Limpieza c√≥digo deprecado** - Eliminar referencias a TC_ADDITIONALINTEREST en TransformerFactoryProducer, OperationValidationFactory y EnrichmentProcessing. Reduce deuda t√©cnica antes de agregar nueva funcionalidad.
   - Dependencias: Regex modificado para que tests de regresi√≥n pasen

3. **Interface ContactCreationStrategy.gs** - Crear contrato base para estrategias de creaci√≥n de contactos.
   - Dependencias: Limpieza completada

4. **DummyContactCreationStrategy.gs** - Implementar estrategia para contactos Dummy reutilizando ContactUtil existente.
   - Dependencias: Interface creada

5. **CompleteContactCreationStrategy.gs** - Implementar estrategia para contactos completos encapsulando comportamiento actual.
   - Dependencias: Interface creada

6. **ContactCreationStrategyFactory.gs** - Implementar factory con tabla de decisi√≥n de 4 escenarios y validaciones de consistencia.
   - Dependencias: Ambas estrategias implementadas

7. **DefaultBeneficiaryTransformer.gs** - Refactorizar m√©todo `createInterestContingent()` para usar factory de estrategias.
   - Dependencias: Factory y estrategias creadas y testeadas

8. **CommonTransformer.contactToAdditionalInterest()** - Extender para soportar PersonDummy_Ext y CompanyDummy_Ext con type checking.
   - Dependencias: Transformador refactorizado

9. **Suite de pruebas E2E** - Validar 6 escenarios de aceptaci√≥n con carga masiva real en ambiente QA.
   - Dependencias: TODOS los componentes desplegados

### Validaci√≥n de Impacto

**Validaci√≥n T√©cnica Realizada (Paso 1.5 - Revisi√≥n de C√≥digo Real):**

Se valid√≥ c√≥digo fuente de componentes mencionados en la historia ANTES de dise√±ar soluci√≥n:

1. **Azure DataFactory controlSchema/Beneficiaries/regex.csv (VALIDADO):**
   - Estado actual: Validaciones con expresiones regulares hacen OBLIGATORIOS los campos TIPO_DOCUMENTO_BENEFICIARIO_X y NUM_DOCUMENTO_BENEFICIARIO_X
   - Impacto: Sin modificaci√≥n, archivos CSV con campos vac√≠os son rechazados en Fase 1 (ErrorFase1_{md5}.csv)
   - Consumidores: Pipeline `startFileValidation` de Azure Data Factory
   - Cadena de invocaci√≥n: BlobCreated Event ‚Üí DataFactory Pipeline ‚Üí Regex Validation ‚Üí Cosmos DB insert (VALIDATED o ERROR_PHASE1)
   - Performance: Sin impacto - solo relajar regex no afecta tiempo de procesamiento

2. **DefaultBeneficiaryTransformer.gs l√≠neas 85-95 (VALIDADO):**
   - Estado actual: Busca contacto con `_iContactPlugin.searchContact()` directamente sin validar campos vac√≠os
   - Consumidores: EnrichmentProcessing.transform() ‚Üí TransformerFactory ‚Üí DefaultBeneficiaryTransformer
   - Dependencias: `_iContactPlugin` (IContactPlugin interface), `_commonTransformer` (CommonTransformer class)
   - Impacto: Refactorizaci√≥n NO afecta contrato p√∫blico del transformador. Solo cambia implementaci√≥n interna de `createInterestContingent()`
   - Performance: Agregar Factory Pattern agrega 1 llamada adicional (factory.getStrategy()) - impacto despreciable (<1ms por registro)

3. **CommonTransformer.contactToAdditionalInterest() l√≠neas 350-375 (VALIDADO):**
   - Estado actual: Maneja Person y Company est√°ndar. M√©todo `setPersonAdditionalInterestData()` espera Contact, no PersonDummy_Ext
   - Consumidores: DefaultBeneficiaryTransformer.createInterestContingent() (l√≠nea 90)
   - Impacto: Extensi√≥n con type checking NO afecta comportamiento actual. Solo agrega nuevos casos antes de l√≥gica existente
   - Cadena de invocaci√≥n: EnrichmentProcessing ‚Üí DefaultBeneficiaryTransformer ‚Üí CommonTransformer.contactToAdditionalInterest() ‚Üí PersonExtDTO/CompanyExtDTO ‚Üí AdditionalInterestDTO
   - Performance: Type checking con `typeis` es operaci√≥n O(1) en Gosu - sin impacto medible

4. **ContactUtil.createNewContactDummy() l√≠neas 233-243 (VALIDADO - REUTILIZABLE):**
   - Estado actual: M√©todo existente del flujo uno-a-uno. Crea PersonDummy_Ext o CompanyDummy_Ext correctamente
   - Evidencia: Usado en `getPolicyAddlInterestForDummyContact()` l√≠nea 135, llamado desde PCF `NewAdditionalInterestDummyPopup.pcf`
   - Consumidores actuales: UI uno-a-uno de beneficiarios
   - Impacto: Reutilizaci√≥n en flujo masivo NO afecta flujo uno-a-uno. Sin dependencias compartidas mutables
   - Validaci√≥n: M√©todo es stateless y thread-safe - seguro para uso en Workqueues (procesamiento batch)

5. **EnrichmentProcessing.getOperationValidation() l√≠neas 166-172 (C√ìDIGO DEPRECADO IDENTIFICADO):**
   - Estado actual: L√≥gica especial `if (message.FileType == typekey.MassiveLoadFileType.TC_BENEFICIARIES)` llama m√©todo diferente
   - An√°lisis: M√©todo `createOperationValidatorInstanceBeneficiary()` solo valida TC_POLICYCHANGE (igual que validaci√≥n est√°ndar)
   - Consumidores: M√©todo `validations()` l√≠nea 163
   - Impacto de eliminaci√≥n: NINGUNO - ambos caminos ejecutan la misma validaci√≥n para beneficiarios
   - Deuda t√©cnica: C√≥digo duplicado innecesario. Eliminar simplifica mantenimiento

6. **TransformerFactoryProducer l√≠nea 9 (C√ìDIGO DEPRECADO IDENTIFICADO):**
   - Estado actual: Caso `TC_ADDITIONALINTEREST` retorna `BeneficiaryTransformerFactory` (igual que `TC_BENEFICIARIES`)
   - An√°lisis: TC_ADDITIONALINTEREST es versi√≥n deprecada que no se usa en producci√≥n
   - Consumidores: EnrichmentProcessing.transform() l√≠nea 175
   - Impacto de eliminaci√≥n: NINGUNO - no hay cargas masivas con FileType TC_ADDITIONALINTEREST en sistema
   - Validaci√≥n: Revisi√≥n de MassiveUploadMessage_Ext en base de datos confirma solo TC_RISK y TC_BENEFICIARIES en uso

**Hallazgos Cr√≠ticos:**

- ‚úÖ EdgeProcessing.gs NO requiere cambios - Reemplazo de beneficiarios ya funciona para cualquier tipo de contacto (Dummy o Complete)
- ‚úÖ IContactPlugin.searchContact() retorna `null` cuando no encuentra contacto - DummyContactCreationStrategy crea nuevo en ese caso
- ‚úÖ CommonTransformer.contactToAdditionalInterest() YA crea contactos cuando `contact == null` (l√≠nea 356-375) - Comportamiento actual debe extenderse, no reemplazarse
- ‚ö†Ô∏è PersonDummy_Ext y CompanyDummy_Ext heredan de Person y Company - Son compatibles con polimorfismo pero requieren type checking expl√≠cito para mapeo correcto a DTO
- ‚ö†Ô∏è Regex de Azure es complejo (1 l√≠nea con 4000+ caracteres) - Modificaci√≥n requiere validaci√≥n exhaustiva con dataset de prueba (50+ variaciones)

**An√°lisis de Dependencias:**

Componentes upstream (afectan esta historia):
- Azure Storage Account (almacenamiento de archivo CSV) - Sin cambios requeridos
- Azure Function Massive Upload (recepci√≥n de bloques) - Sin cambios requeridos
- RabbitMQ (notificaciones entre fases) - Sin cambios requeridos

Componentes downstream (afectados por esta historia):
- EdgeProcessing.gs (inserta beneficiarios) - Ya compatible con contactos Dummy (validado)
- UI de PolicyCenter (visualizaci√≥n de beneficiarios) - Ya renderiza contactos Dummy correctamente (flujo uno-a-uno existente)
- Reportes de beneficiarios - Requieren validaci√≥n en QA (no documentado si manejan Dummy)

### Notas T√©cnicas

**Consideraciones Especiales:**

1. **Determinaci√≥n autom√°tica Persona vs Compa√±√≠a para Dummy:**
   - L√≥gica propuesta: Si campo PRIMER_APELLIDO_BENEFICIARIO_X tiene valor ‚Üí PersonDummy_Ext, sino ‚Üí CompanyDummy_Ext
   - Alternativa descartada: Campo adicional en CSV para especificar tipo - Rechazada para mantener plantilla sin cambios (requisito de negocio)
   - Riesgo: Usuario ingresa nombre de compa√±√≠a con apellido por error ‚Üí Sistema crea PersonDummy incorrectamente
   - Mitigaci√≥n: Documentar claramente en manual de usuario que apellido vac√≠o = compa√±√≠a

2. **Identificaci√≥n interna de contactos Dummy:**
   - ContactUtil.createNewContactDummy() usa `PublicID` generado autom√°ticamente por Guidewire como identificaci√≥n interna
   - Formato: UUID (ej: "pc:12345678")
   - Ventaja: Sin colisiones, √∫nico por contacto
   - Desventaja: No es human-readable en reportes
   - Alternativa considerada: Secuencia con prefijo "DUMMY-" - Descartada por complejidad de gesti√≥n de secuencias distribuidas

3. **Direcci√≥n Dummy est√°ndar:**
   - Reutilizar configuraci√≥n existente de ContactUtil.updateAddressDummy():
     - PersonDummy: AddressLine1="No existe", Country=CO, State=CO05 (Antioquia), City=05001000 (Medell√≠n)
     - CompanyDummy: Igual que PersonDummy (por defecto)
   - Comportamiento coherente con flujo uno-a-uno existente

4. **Validaci√≥n de integridad en Fase 1 vs Fase 2:**
   - Azure (Fase 1): Solo valida formato con regex. NO valida regla "uno vac√≠o, otro lleno = error"
   - PolicyCenter (Fase 2): ContactCreationStrategyFactory lanza ValidationException para casos inconsistentes
   - Raz√≥n: Validaciones de negocio pertenecen a Fase 2 (PolicyCenter), no a Fase 1 (Azure)
   - Resultado: Registros inconsistentes pasan Fase 1 pero son rechazados en Fase 2 con mensaje claro en ErrorFase2_{md5}.csv

5. **Reemplazo total de beneficiarios - Comportamiento Esperado:**
   - EdgeProcessing.gs ya implementa reemplazo total (no fusi√≥n)
   - Si riesgo tiene Beneficiarios A y B, y se carga archivo con Beneficiario C ‚Üí Resultado final: solo C
   - Aplica tanto para beneficiarios Dummy como Complete
   - NO se requiere implementaci√≥n adicional

**Alternativas Descartadas:**

1. **Crear flujo paralelo espec√≠fico para Dummy:**
   - Descartado: Duplicar√≠a infraestructura (PCF, JavaScript, Azure pipelines, Workqueues)
   - Justificaci√≥n: Reutilizar flujo existente con l√≥gica de decisi√≥n es m√°s mantenible y escalable

2. **Modificar plantilla CSV para agregar columna "TIPO_CONTACTO":**
   - Descartado: Cambios en plantilla requieren actualizar documentaci√≥n de usuario, capacitaciones, y validaci√≥n de 1000+ archivos CSV hist√≥ricos
   - Justificaci√≥n: Determinaci√≥n autom√°tica basada en campos existentes cumple requisitos sin cambios visibles a usuario

3. **Validar integridad de campos en Azure DataFactory (Fase 1):**
   - Descartado: Azure DataFactory solo debe validar formato, no reglas de negocio
   - Justificaci√≥n: Separaci√≥n de responsabilidades - Fase 1 formato, Fase 2 negocio. Facilita depuraci√≥n y mantenimiento

4. **Usar condicionales inline en lugar de Strategy Pattern:**
   - Descartado: C√≥digo resultante ser√≠a dif√≠cil de testear (m√∫ltiples branches anidados) y extender
   - Justificaci√≥n: Strategy Pattern permite tests unitarios independientes y extensi√≥n futura sin modificar core

**Advertencias de Implementaci√≥n:**

- ‚ö†Ô∏è **CR√çTICO**: Modificar regex.csv primero. Sin este cambio, todo el resto del desarrollo es in√∫til (registros nunca llegan a Fase 2)
- ‚ö†Ô∏è **CR√çTICO**: Tests de regresi√≥n exhaustivos de cargas de Riesgos existentes despu√©s de eliminar TC_ADDITIONALINTEREST
- ‚ö†Ô∏è Validar que PersonDummy_Ext y CompanyDummy_Ext tienen typelist IdentificationType_Ext configurado con "DummyPerson" y "DummyCompany"
- ‚ö†Ô∏è CommonTransformer.contactToAdditionalInterest() debe preservar comportamiento actual para contactos est√°ndar (regression tests)
- ‚ö†Ô∏è Strategy Pattern agrega nivel de indirecci√≥n - Documentar claramente en c√≥digo cu√°ndo usar cada estrategia

**Recomendaciones:**

1. Implementar feature flag para activar/desactivar creaci√≥n de Dummy en producci√≥n durante rollout gradual
2. Agregar m√©tricas de monitoring: contador de beneficiarios Dummy creados por carga (Cosmos DB o Application Insights)
3. Considerar agregar validaci√≥n adicional en UI de PolicyCenter para alertar a expedidor cuando carga contiene >80% de Dummy (posible error de plantilla)
4. Documentar en Knowledge Base: Diferencia entre beneficiario Dummy (carga masiva) vs Dummy (uno-a-uno) - Comportamiento id√©ntico pero flujos diferentes

### Referencias y Validaci√≥n

**Documentaci√≥n consultada:**

- Flujo de Carga Masiva de Riesgos y Beneficiarios - docs/architecture/flujo-carga-masiva-riesgos-beneficiarios.md (855 l√≠neas)
- GPS Arquitect√≥nico del Sistema - docs/architecture/index.md (1868 l√≠neas)
- Arquitectura PolicyCenter - docs/architecture/architecture-policycenter.md (588 l√≠neas)

**Historias relacionadas:**

- Historia #915240: Bug - Organizar campos errados detalle de cobro - Patr√≥n de validaci√≥n de integridad de datos en reportes masivos
- Historia #830317: Ajustar comportamiento descarga detalle cobro - Manejo de archivos de errores y notificaciones a usuario

**C√≥digo fuente validado (Paso 1.5):**

- PolicyCenter/modules/configuration/gsrc/sura/pc/massiveupload/transformer/DefaultBeneficiaryTransformer.gs (l√≠neas 1-150)
- PolicyCenter/modules/configuration/gsrc/sura/pc/massiveupload/transformer/common/CommonTransformer.gs (l√≠neas 150-400)
- PolicyCenter/modules/configuration/gsrc/sura/pc/util/ContactUtil.gs (l√≠neas 100-249)
- PolicyCenter/modules/configuration/gsrc/sura/pc/massiveupload/batch/enrichment/EnrichmentProcessing.gs (l√≠neas 150-230)
- PolicyCenter/modules/configuration/gsrc/sura/pc/massiveupload/validations/factories/OperationValidationFactory.gs (l√≠neas 1-100)
- PolicyCenter/modules/configuration/gsrc/sura/pc/massiveupload/transformer/factories/TransformerFactoryProducer.gs (l√≠neas 1-50)
- VidaGrupoIAC/modules/datafactory/controlSchema/Beneficiaries/regex.csv (validaciones completas)
- VidaGrupoIAC/modules/datafactory/controlSchema/Beneficiaries/control.csv (estructura de plantilla)
- PolicyCenter/modules/configuration/config/extensions/entity/PersonDummy_Ext.eti (entidad existente)
- PolicyCenter/modules/configuration/config/extensions/entity/CompanyDummy_Ext.eti (entidad existente)

**Validado por:** esteban.colorado | **Fecha:** 2025-12-22 | **Enfoque:** B - Exploratorio con consideraciones t√©cnicas espec√≠ficas del flujo existente

---

## Metadata

**Autor:** esteban.colorado (PO)  
**Fecha:** 2025-12-18  
**Historias relacionadas:** #915240, #830317  
**Modo de creaci√≥n:** Importar historia existente (validada y mejorada)

---

## M√©tricas de redacci√≥n de la historia de usuario con el PO 

**Tiempo con M√©todo Ceiba:** 12 minutos  
**Tiempo estimado tradicional:** 30 minutos  
**Optimizaci√≥n:** 60%

---

## Estimaci√≥n

**Estimador:** esteban.colorado  
**Fecha:** 2025-12-23

### Estimaci√≥n por Tareas

#### Tareas Aumentadas por IA (Impactadas por M√©todo Ceiba)

**Leyenda:** MC = M√©todo Ceiba

| # | Tarea | Complejidad | Junior | Semi Sr | Senior | MC Jr | MC Semi Sr | MC Sr |
|---|-------|-------------|--------|---------|--------|-------|------------|-------|
| 1 | Modificar validaciones de Azure Data Factory | ALTO | 10.8h | 6.9h | 4.3h | 4.3h | 2.7h | **1.7h** |
| 2 | Eliminar referencia TC_ADDITIONALINTEREST | BAJO | 1.7h | 1.3h | 1.1h | 0.7h | 0.4h | **0.4h** |
| 3 | Eliminar validaci√≥n duplicada OperationValidationFactory | BAJO | 1.5h | 1.2h | 1.0h | 0.6h | 0.4h | **0.4h** |
| 4 | Simplificar m√©todo getOperationValidation | MEDIO | 4.3h | 2.7h | 1.7h | 1.7h | 1.1h | **0.7h** |
| 5 | Crear interface ContactCreationStrategy | BAJO | 1.7h | 1.3h | 1.1h | 0.7h | 0.4h | **0.4h** |
| 6 | Implementar DummyContactCreationStrategy + Tests | MEDIO | 10.0h | 6.4h | 4.0h | 4.0h | 2.6h | **1.6h** |
| 7 | Implementar CompleteContactCreationStrategy + Tests | MEDIO | 8.0h | 5.1h | 3.2h | 3.2h | 2.0h | **1.3h** |
| 8 | Implementar ContactCreationStrategyFactory + Tests | MEDIO | 7.8h | 5.0h | 3.1h | 3.1h | 2.0h | **1.2h** |
| 9 | Refactorizar DefaultBeneficiaryTransformer.createInterestContingent() | MEDIO | 8.0h | 5.1h | 3.2h | 3.2h | 2.0h | **1.3h** |
| 10 | Extender CommonTransformer.contactToAdditionalInterest() | MEDIO | 9.5h | 6.1h | 3.8h | 3.8h | 2.4h | **1.5h** |

#### Tareas Manuales (No Impactadas por M√©todo Ceiba)

Estas tareas requieren intervenci√≥n humana directa y no se benefician de la optimizaci√≥n por IA.

| # | Tarea | Tiempo Estimado | Fuente |
|---|-------|-----------------|--------|
| 11 | Crear dataset de prueba exhaustivo (50+ escenarios CSV) | 3.2h | estimacion |
| 12 | Validaci√≥n de visualizaci√≥n en UI | 1.1h | estimacion |
| 13 | Ejecutar Agente Peer Review | 1.7h | estimacion |
| 14 | Resolver incidentes del Peer Review (Condicional) | 2.2h | estimacion |
| 15 | Crear Pull Request | 0.5h | estimacion |
| 16 | Ejecutar pipeline deployment DEV | 1.1h | estimacion |
| 17 | Dise√±ar set de pruebas manuales | 2.0h | estimacion |
| 18 | Ejecutar pruebas manuales | 4.0h | estimacion |

**Total Tareas Manuales:** 15.8h

**Leyenda fuentes:**
- `pivote-dod`: Tiempo obtenido de tabla de Definition of Done preconfigurada
- `estimacion`: Tiempo calculado usando m√©todo PERT

### Totales Comparativos por Rol

#### üìä Estimaci√≥n Completa: Tradicional vs M√©todo Ceiba

**Conversi√≥n:** 1 punto = 1 d√≠a laboral = 9 horas

| Perfil | Desarrollo Tradicional (SIN IA) | Desarrollo con M√©todo Ceiba (CON IA) | Ahorro de Tiempo |
|--------|----------------------------------|--------------------------------------|------------------|
| **Junior** | **79.1h** (8.8 puntos) | **42.1h** (4.7 puntos) | **37.0h** (4.1 puntos) - **47% menos** |
| **Semi Senior** | **57.9h** (6.4 puntos) | **31.8h** (3.5 puntos) | **26.1h** (2.9 puntos) - **45% menos** |
| **Senior** | **42.3h** (4.7 puntos) | **26.3h** (2.9 puntos) | **16.0h** (1.8 puntos) - **38% menos** |

#### üìå Desglose por Componente

##### Desarrollo Tradicional (SIN IA - Sin asistencia de herramientas de IA)

| Perfil | Tareas de C√≥digo | Tareas Manuales | Total | Puntos |
|--------|------------------|-----------------|-------|--------|
| Junior | 63.3h | 15.8h | 79.1h | 8.8 puntos |
| Semi Senior | 42.1h | 15.8h | 57.9h | 6.4 puntos |
| **Senior** | **26.5h** | **15.8h** | **42.3h** | **4.7 puntos** |

##### Desarrollo con M√©todo Ceiba (CON IA - Optimizado con herramientas de IA)

| Perfil | Tareas de C√≥digo (MC) | Tareas Manuales | Total | Puntos |
|--------|-----------------------|-----------------|-------|--------|
| Junior | 26.3h | 15.8h | 42.1h | 4.7 puntos |
| Semi Senior | 16.0h | 15.8h | 31.8h | 3.5 puntos |
| **Senior** | **10.5h** | **15.8h** | **26.3h** | **2.9 puntos** |

**Optimizaci√≥n en Tareas de C√≥digo:**
- M√©todo Ceiba reduce el tiempo de desarrollo de c√≥digo en **60%** aplicando descuento de IA sobre estimaci√≥n tradicional
- Las tareas manuales (15.8h) no se benefician de IA y permanecen constantes en ambos escenarios

#### üéØ Recomendaci√≥n de Asignaci√≥n para Sprint Planning

**Escenario SIN M√©todo Ceiba (Tradicional):**
- Senior: **5 puntos**
- Semi Senior: **6-7 puntos**
- Junior: **9 puntos**

**Escenario CON M√©todo Ceiba (Recomendado):**
- **Senior: 3 puntos** ‚≠ê (redondeado desde 2.9)
- Semi Senior: **4 puntos** (redondeado desde 3.5)
- Junior: **5 puntos** (redondeado desde 4.7)

### Notas Adicionales

**Supuestos de Estimaci√≥n:**
- Desarrollador tiene experiencia previa con Guidewire PolicyCenter y Gosu
- Ambiente de desarrollo est√° configurado y funcional
- Acceso a Azure Data Factory para modificar regex.csv est√° disponible
- No hay cambios en requisitos durante la implementaci√≥n

**Riesgos Identificados:**
- **CR√çTICO (4.3h de riesgo):** Modificaci√≥n de regex.csv puede romper validaciones existentes - requiere dataset exhaustivo de prueba
- **ALTO (2h de riesgo):** Tests de regresi√≥n despu√©s de eliminar TC_ADDITIONALINTEREST deben cubrir todos los tipos de carga
- **MEDIO (1.5h de riesgo):** Determinaci√≥n autom√°tica Persona vs Compa√±√≠a puede causar errores si usuario ingresa nombre incorrecto

**Tareas con Alta Incertidumbre (Riesgo > 3h):**
- Tarea 1: Modificar validaciones de Azure Data Factory (Riesgo: 6h - CR√çTICO)
- Tarea 6: Implementar DummyContactCreationStrategy + Tests (Riesgo: 4h)

**Recomendaciones:**
- Considerar spike t√©cnico para validaci√≥n de regex.csv antes de implementaci√≥n
- Ejecutar tests de regresi√≥n completos despu√©s de Fase 1 (limpieza c√≥digo deprecado)
- Validar dataset de prueba con expedidores reales antes de deployment a producci√≥n

---

*Estimaci√≥n generada usando workflow estimar-historia-usuario del M√©todo Ceiba.*

---
