<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/.ceiba-metodo/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>
  <critical>CONTEXT BUDGET: MÃ¡ximo 12000 tokens totales para prevenir context exhaustion</critical>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- RESTRICCIONES ABSOLUTAS DEL ROL DE REVIEWER                              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <critical id="NO_IMPLEMENTATION">
    ğŸš« PROHIBIDO IMPLEMENTAR CÃ“DIGO ğŸš«
    
    Este workflow es SOLO para REVISIÃ“N. NUNCA debes:
    - Modificar archivos de cÃ³digo fuente (.ts, .js, .java, .py, etc.)
    - Crear nuevos archivos de implementaciÃ³n
    - Ejecutar comandos que modifiquen el cÃ³digo
    - Hacer fixes, correcciones o mejoras al cÃ³digo
    
    Si el usuario pide implementar cambios, corregir cÃ³digo, o hacer fixes:
    â†’ RECHAZAR la solicitud
    â†’ Responder: "Como Peer Reviewer, mi rol es Ãºnicamente REVISAR cÃ³digo, no implementarlo. 
       Para implementar los cambios solicitados, ejecuta el workflow *desarrollar-historia-usuario 
       con el agente Developer."
    
    El ÃšNICO archivo que este workflow puede modificar es el archivo de historia (.story.md)
    para agregar la secciÃ³n de revisiÃ³n y actualizar el Status.
  </critical>

  <critical id="MANDATORY_PERSISTENCE">
    ğŸ“ PERSISTENCIA OBLIGATORIA ğŸ“
    
    ANTES de mostrar el resultado final al usuario, DEBES:
    1. Escribir la secciÃ³n "## RevisiÃ³n de CÃ³digo (Peer Review)" en {{story_path}}
    2. Actualizar el campo "Status:" segÃºn la decisiÃ³n
    3. Verificar que los cambios se guardaron correctamente
    
    Si la persistencia falla:
    â†’ Reintentar hasta 3 veces
    â†’ Si sigue fallando, mostrar ERROR CRÃTICO y el contenido que debÃ­a persistirse
    
    NUNCA mostrar "RevisiÃ³n completada" sin haber persistido en el archivo.
  </critical>

  <critical>
    DEBES ejecutar 5 sub-workflows EN SECUENCIA.
    NO ofrezcas alternativas. NO hagas "revisiÃ³n consolidada".
    Este workflow estÃ¡ diseÃ±ado para ser EXHAUSTIVO.
    
    Los 5 sub-workflows son:
    [1/5] contexto-tecnico      â†’ Carga arquitectura y detecta stack
    [2/5] validacion-implementacion â†’ ACs + coherencia arquitectÃ³nica  
    [3/5] analisis-codigo       â†’ Seguridad + Backend + Frontend
    [4/5] validacion-testing    â†’ Tests unitarios + integraciÃ³n
    [5/5] decision-outcome      â†’ DecisiÃ³n final
    
    Para CADA sub-workflow:
    1. Mostrar "â•â•â• EJECUTANDO [X/5]: nombre â•â•â•"
    2. Cargar instructions.md del sub-workflow
    3. Ejecutar el anÃ¡lisis
    4. Generar output en formato Markdown (NO JSON)
    5. Mostrar "[X/5] âœ… COMPLETADO"
  </critical>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP -1: Validar ConfiguraciÃ³n del Proyecto                              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="-1" goal="Validar configuraciÃ³n del proyecto">
    <critical>VALIDACIÃ“N BLOQUEANTE - El proyecto debe tener archivos de configuraciÃ³n obligatorios</critical>
    
    <invoke-protocol name="validate_project_prerequisites" />
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 0: Localizar historia                                               -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="0" goal="Localizar historia y preparar archivos">
    <ask>Â¿QuÃ© historia de usuario o incidente deseas revisar? (nÃºmero o ruta)</ask>
    
    <action>Determinar tipo de documento (historia si .story.md o incidente si .incident.md o contiene INC-)</action>
    <action>Buscar archivo en {dev_story_location} o {incident_location}</action>
    <action>Leer contenido completo del archivo</action>
    <action>Extraer: Status, ACs, Tasks, Lista de Archivos</action>
    <action>Obtener archivos modificados (git o Lista de Archivos)</action>
    
    <check if="Status no vÃ¡lido para revisiÃ³n">
      <halt>Estado incorrecto: {{estado_actual}}</halt>
    </check>
    
    <output>{{document_type}} {{story_number}} - {{staged_files.length}} archivos a revisar</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 0.5: Validar Cumplimiento del Flujo de Desarrollo (PRERREQUISITO)   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="0.5" goal="Validar que el documento completÃ³ el flujo de desarrollo MÃ©todo Ceiba">
    <output>â•â•â• VALIDACIÃ“N PRERREQUISITO: Flujo de Desarrollo MÃ©todo Ceiba â•â•â•</output>
    
    <critical>Este diagnÃ³stico es BLOQUEANTE - si falla, NO continuar con la revisiÃ³n</critical>
    
    <task-invoke file="{installed_path}/tasks/diagnostic-metodo-flujo-desarrollo.xml">
      <input name="story_file_content" value="{{story_file_content}}" />
      <input name="story_number" value="{{story_number}}" />
      <input name="document_type" value="{{document_type}}" />
    </task-invoke>
    
    <expected-output format="markdown">
      ### Cumplimiento del Flujo de Desarrollo (MÃ©todo Ceiba)
      
      | Fase | Estado | Evidencia | AcciÃ³n Requerida |
      |------|--------|-----------|------------------|
      ...
      
      **Resumen**: X% cumplimiento
    </expected-output>
    
    <check if="has_blocking_issues == true">
      <halt>
â›” REVISIÃ“N BLOQUEADA

El documento NO ha completado todas las fases obligatorias del flujo de desarrollo.
Por favor ejecuta los workflows indicados en el reporte antes de solicitar revisiÃ³n.

{{blocking_issues_detail}}
      </halt>
    </check>
    
    <check if="has_warnings == true">
      <output>âš ï¸ ADVERTENCIAS: {{warnings_summary}}</output>
      <output>Continuando con la revisiÃ³n...</output>
    </check>
    
    <output>âœ… Flujo de desarrollo validado - Continuando con revisiÃ³n de cÃ³digo</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 1: Contexto TÃ©cnico [1/5]                                           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="1" goal="Cargar contexto tÃ©cnico">
    <output>â•â•â• EJECUTANDO [1/5]: contexto-tecnico â•â•â•</output>
    
    <invoke path="{installed_path}/sub-workflows/1-contexto-tecnico/">
      <input>staged_files, architecture_location</input>
    </invoke>
    
    <action>Almacenar en {{manual_context}}: stack, docs, GPS arquitectÃ³nico</action>
    
    <output>[1/5] âœ… contexto-tecnico COMPLETADO - Stack: {{stack}}, Docs: {{docs_count}}</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 2: ValidaciÃ³n de ImplementaciÃ³n [2/5]                               -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="2" goal="Validar implementaciÃ³n vs requisitos">
    <output>â•â•â• EJECUTANDO [2/5]: validacion-implementacion â•â•â•</output>
    
    <invoke path="{installed_path}/sub-workflows/2-validacion-implementacion/">
      <input>story_context, staged_files, manual_context</input>
    </invoke>
    
    <expected-output format="markdown">
      ## [2/5] ValidaciÃ³n de ImplementaciÃ³n
      
      ### Criterios de AceptaciÃ³n
      | AC | Estado | ImplementaciÃ³n | Tests | Gaps |
      |----|--------|----------------|-------|------|
      ...
      **Resumen**: X/Y ACs cubiertos
      
      ### Coherencia ArquitectÃ³nica
      | Severidad | Tipo | Issue | Archivos |
      ...
      **Resumen**: N issues
    </expected-output>
    
    <action>Agregar hallazgos a {{all_findings}}</action>
    
    <output>[2/5] âœ… validacion-implementacion COMPLETADO - ACs: {{ac_covered}}/{{ac_total}}, Issues: {{coherence_count}}</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 3: AnÃ¡lisis de CÃ³digo [3/5]                                         -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="3" goal="Analizar cÃ³digo: seguridad, backend, frontend">
    <output>â•â•â• EJECUTANDO [3/5]: analisis-codigo â•â•â•</output>
    
    <invoke path="{installed_path}/sub-workflows/3-analisis-codigo/">
      <input>staged_files, story_number, manual_context</input>
    </invoke>
    
    <expected-output format="markdown">
      ## [3/5] AnÃ¡lisis de CÃ³digo
      
      ### Seguridad (OWASP/BOLA)
      | Severidad | CategorÃ­a | Issue | Archivo | LÃ­nea |
      ...
      **Resumen**: X hallazgos seguridad
      
      ### Backend
      | Severidad | Tipo | Issue | Archivo | LÃ­nea |
      ...
      **Resumen**: Y hallazgos backend
      
      ### Frontend
      [tabla o "No Aplica"]
      **Resumen**: Z hallazgos frontend
    </expected-output>
    
    <action>Agregar hallazgos a {{all_findings}}</action>
    
    <output>[3/5] âœ… analisis-codigo COMPLETADO - Seguridad: {{sec}}, Backend: {{back}}, Frontend: {{front}}</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 4: ValidaciÃ³n de Testing [4/5]                                      -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="4" goal="Validar cobertura de tests">
    <output>â•â•â• EJECUTANDO [4/5]: validacion-testing â•â•â•</output>
    
    <invoke path="{installed_path}/sub-workflows/4-validacion-testing/">
      <input>staged_files, story_number, manual_context</input>
    </invoke>
    
    <expected-output format="markdown">
      ## [4/5] ValidaciÃ³n de Testing
      
      ### Tests Unitarios
      **MÃ©tricas**: X impl, Y tests, Z% cobertura
      | Severidad | Issue | Archivo | Detalle |
      ...
      
      ### Tests de IntegraciÃ³n
      **MÃ©tricas**: Documentados: X, Implementados: Y
      | Severidad | Issue | Detalle |
      ...
    </expected-output>
    
    <action>Agregar hallazgos a {{all_findings}}</action>
    
    <output>[4/5] âœ… validacion-testing COMPLETADO - Unitarios: {{unit}}, IntegraciÃ³n: {{integ}}</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 5: DecisiÃ³n Final [5/5]                                             -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="5" goal="Consolidar y decidir">
    <output>â•â•â• EJECUTANDO [5/5]: decision-outcome â•â•â•</output>
    
    <action>Deduplicar {{all_findings}}</action>
    <action>Calcular estadÃ­sticas: total, por severidad, por categorÃ­a</action>
    
    <invoke path="{installed_path}/sub-workflows/5-decision-outcome/">
      <input>all_findings, statistics, manual_context</input>
    </invoke>
    
    <decision-rules>
      BLOQUEADO si:
        - >3 hallazgos ALTA
        - AC crÃ­tico sin implementar
        - Vulnerabilidad OWASP crÃ­tica
      
      CAMBIOS SOLICITADOS si:
        - 1-3 hallazgos ALTA
        - ACs parcialmente cubiertos
        - Tests faltantes
      
      APROBADO si:
        - 0 hallazgos ALTA
        - Todos los ACs cubiertos
        - Solo issues menores
    </decision-rules>
    
    <output>[5/5] âœ… decision-outcome COMPLETADO - DecisiÃ³n: {{outcome}}</output>
  </step>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 6: PERSISTIR REPORTE EN HISTORIA                                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <step n="6" goal="Persistir reporte en archivo de historia">
    <critical>DEBES escribir el reporte EN EL ARCHIVO DE HISTORIA usando replace_string_in_file o crear secciÃ³n al final</critical>
    <critical>DEBES actualizar el campo Status segÃºn la decisiÃ³n tomada</critical>
    
    <action>Leer archivo {{story_path}} completo</action>
    
    <action>Buscar si existe secciÃ³n "## RevisiÃ³n de CÃ³digo (Peer Review)"</action>
    <check if="secciÃ³n existe">
      <action>Reemplazar secciÃ³n completa con el nuevo reporte</action>
    </check>
    <check if="secciÃ³n NO existe">
      <action>Agregar nueva secciÃ³n al final del archivo antes de cualquier "---" final</action>
    </check>
    
    <action>Cargar template desde {installed_path}/template.md</action>
    <action>Renderizar template reemplazando todas las variables {{variable}} con los valores calculados</action>
    <action>Para campos vacÃ­os usar defaults: tabla_* = "Sin hallazgos", tabla_frontend = "No aplica" si no hay archivos frontend</action>
    
    <action>Actualizar campo "Status:" en el archivo segÃºn outcome:</action>
    <status-mapping>
      - Si outcome == "Aprobado" â†’ Status: "Aprobada"
      - Si outcome == "Aprobado con Observaciones" â†’ Status: "Aprobada con Observaciones"  
      - Si outcome == "Cambios Solicitados" â†’ Status: "Cambios Solicitados"
      - Si outcome == "Bloqueado" â†’ Status: "Bloqueada"
    </status-mapping>
    
    <mandatory-actions>
      <action order="1">EJECUTAR replace_string_in_file para actualizar Status en la cabecera</action>
      <action order="2">EJECUTAR replace_string_in_file para agregar/reemplazar secciÃ³n de revisiÃ³n</action>
      <action order="3">VERIFICAR que ambas modificaciones se aplicaron correctamente</action>
    </mandatory-actions>
    
    <on-failure>
      <retry max="3">Reintentar la escritura del archivo</retry>
      <fallback>
        <output>
âš ï¸ ERROR CRÃTICO: No se pudo persistir la revisiÃ³n en el archivo.

Por favor, copia manualmente el siguiente contenido al final del archivo {{story_path}}:

{{contenido_seccion_revision}}

Y actualiza el Status a: {{new_status}}
        </output>
      </fallback>
    </on-failure>
    
    <post-validation>
      <action>Leer {{story_path}} nuevamente</action>
      <check if="secciÃ³n 'RevisiÃ³n de CÃ³digo' NO existe en archivo">
        <halt>ERROR: La secciÃ³n de revisiÃ³n NO fue persistida. Reintentando...</halt>
      </check>
      <check if="Status NO fue actualizado">
        <halt>ERROR: El Status NO fue actualizado. Reintentando...</halt>
      </check>
    </post-validation>
    
    <output>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… REVISIÃ“N COMPLETADA Y PERSISTIDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Historia: {{story_number}}
DecisiÃ³n: {{outcome}}
Archivo actualizado: {{story_path}}

ğŸ“Š Hallazgos totales: {{stats.total}}
- ALTA: {{stats.alta}}
- MEDIA: {{stats.media}}  
- BAJA: {{stats.baja}}

ğŸ“‹ Status actualizado a: {{new_status}}
ğŸ“ SecciÃ³n de revisiÃ³n agregada al archivo

ğŸ‘‰ PrÃ³ximos pasos:
{{next_steps}}

---
âš ï¸ RECORDATORIO: Para implementar los cambios solicitados, usa el workflow 
*desarrollar-historia-usuario con el agente Developer. Este workflow es SOLO revisiÃ³n.
    </output>
  </step>

</workflow>
